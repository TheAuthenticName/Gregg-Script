-- Get Config Settings
local Config = {
    Enabled = getgenv().Config.Enabled,
    Settings = {
        ResetOnGregg = getgenv().Config.Settings.ResetOnGregg,
        ResetInYokai = getgenv().Config.Settings.ResetInYokai,
        ResetInOptimalLocations = getgenv().Config.Settings.ResetInOptimalLocations,
        ShowMaterials = getgenv().Config.Settings.ShowMaterials
    },
    AutoConfiguration = {
        Enabled = getgenv().Config.AutoConfiguration.Enabled,
        Key = getgenv().Config.AutoConfiguration.Key,
        Settings = {
            AvgPingPerAccount = getgenv().Config.AutoConfiguration.AuroraWareSettings.AvgPingPerAccount,
            DisableDodging = getgenv().Config.AutoConfiguration.AuroraWareSettings.DisableDodging
        }
    },
    WebhookSettings = {
        Enabled = getgenv().Config.WebhookSettings.Enabled,
        DisplayName = getgenv().Config.WebhookSettings.DisplayName,
        Url = getgenv().Config.WebhookSettings.Url
    }
}

-- Disable Script if disabled
if Config.Enabled == false then
    return
end

-- Auroraware Configs
local YokaiConfig = {
    Mobs = {
        LimitSpellCasting = true,
        Distance = 20,
        Teleports = {
          Enabled = true,
          Distance = 20,
          Delay = 0.1
        },
        AbilityRange = 50
      },
      Miscellaneous = {
        AggressiveMode = true,
        AutoRetryDungeon = true,
        DisableDodging = false
      },
      CastBetweenEnemies = {
        Enabled = true,
        CastingRange = 80
      },
      Boss = {
        LimitSpellCasting = false,
        Distance = 50,
        Teleports = {
          Enabled = true,
          Distance = 20,
          Delay = 0.1
        },
        AbilityRange = 70
      },
}
local GildedConfig = {}

-- Material table
local Materials = {
    ["Astral Amethyst"] = 0,
    ["Gold Bar"] = 0,
    ["Obsidian Chunk"] = 0,
    ["Warforged Metal"] = 0
}

-- Material Maps
local AmethystMaps = {"Yokai Peak", "Aquatic Temple", "Ghastly Harbor", "King's Castle"}
local GoldMaps = {"Gilded Skies", "Volcanic Chambers", "The Canals", "Pirate Island"}
local ObsidianMaps = {"Northern Lands", "Orbital Outpost", "Samurai Palace", "Winter Outpost"}
local MetalMaps = {"Enchanted Forest", "Steampunk Sewers", "Underworld", "Desert Temple"}

-- Services
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

-- Variables
local Player = Players.LocalPlayer
local PlayerGui = Player.PlayerGui

local dungeon
local dungeonName

local Amount
local Material
local Total

local Json
local Mobs
local Miscellaneous
local CastBetweenEnemies
local Boss

-- Functions
local function WriteData()
    Json = HttpService:JSONEncode(Materials)
    writefile("GreggTracker/Config.json", Json)
end

local function ReadMaterials()
    for index, value in pairs(Materials) do
        print(`{index}: {value}`)
    end
end

local function LoadAuroraware()
    getgenv().Key = Config.AutoConfiguration.Key
    loadstring(request({Url='https://api.dungeonquestroblox.com/Files/Auroraware-dq'}).Body)()
end

local function ReadData()
    Json = HttpService:JSONDecode(readfile("GreggTracker/Config.json"))
end

local function WriteConfigData(ConfigName)
    Json = HttpService:JSONDecode(readfile("AuroraWareV3/Configuration/Settings.json"))

    -- Mob Config
    Json.BaseAutoFarm.Mobs = ConfigName.Mobs
    Mobs = HttpService:JSONEncode(Json)
    writefile("AuroraWareV3/Configuration/Settings.json", Mobs)

    -- Misc Config
    Json.BaseAutoFarm.Miscellaneous = ConfigName.Miscellaneous
    Miscellaneous = HttpService:JSONEncode(Json)
    writefile("AuroraWareV3/Configuration/Settings.json", Miscellaneous)

    -- Casting Config
    Json.BaseAutoFarm.CastBetweenEnemies = ConfigName.CastBetweenEnemies
    CastBetweenEnemies = HttpService:JSONEncode(Json)
    writefile("AuroraWareV3/Configuration/Settings.json", CastBetweenEnemies)

    -- Boss Config
    Json.BaseAutoFarm.Boss = ConfigName.Boss
    Boss = HttpService:JSONEncode(Json)
    writefile("AuroraWareV3/Configuration/Settings.json", Boss)
end

local function ResetPlayer()
    Player.Character.Humanoid.Health = 0
end

local function GreggDied()
    
end

-- Lobby Shit
if game.PlaceId == 2414851778 then
    LoadAuroraware()

    local CraftingMenu = PlayerGui:WaitForChild("CraftingUI"):WaitForChild("Main"):WaitForChild("Topbar")

    task.wait(3)

    for index, value in pairs(Materials) do
        Materials[index] = tonumber(CraftingMenu:FindFirstChild(index).TextLabel.Text)
    end

    ReadMaterials()

    if not isfolder("GreggTracker") then
        warn("No folder found, Creating one!")
        makefolder("GreggTracker")
    else
        warn("Found folder!")
    end

    if not isfile("GreggTracker/Config.json") then
        warn("No config file found, Creating one!")
        WriteData()
    else
        warn("Found config file!")
        WriteData()
    end
end

-- Dungeon Shit
if game.PlaceId == 14363263080 then
    dungeon = game.Workspace:WaitForChild("dungeon")
    dungeonName = game.Workspace:WaitForChild("dungeonName").Value

    -- Auto Config Shit
    if Config.AutoConfiguration.Enabled == true then
        if dungeonName == "Yokai Peak" then

            if Config.AutoConfiguration.Settings.AvgPingPerAccount >= 80 then
                YokaiConfig.Mobs.Teleports.Delay = 0.2
                YokaiConfig.Boss.Teleports.Delay = 0.2
                YokaiConfig.Boss.Teleports.Distance = 16
            end

            WriteConfigData(YokaiConfig)
        end
    end

    LoadAuroraware()

    -- Getting Materials
    if isfile("GreggTracker/Config.json") then
        ReadData()
        for index, value in pairs(Json) do
            Materials[index] = value
        end
    else
        Player:Kick("No config file found!")
    end

    ReadMaterials()

    -- Gegg Settings
    if dungeonName == "Yokai Peak" and Config.Settings.ResetInYokai == true then
        GreggDied()
    else
        GreggDied()
    end

    if Config.Settings.ResetInOptimalLocations == true then
        -- Samurai Palace
        if dungeonName == "Samurai Palace" then
            game.Workspace.DescendantAdded:Connect(function(descendant)
                if descendant.Name == "Sanada Yukimura" then
                    ResetPlayer()
                end
            end)
        end
        elseif dungeonName == "Steampunk Sewers" then
            dungeon.room4.DescendantAdded:Connect(function(descendant)
                if descendant.Name == "Hammer Bot" then
                    ResetPlayer()
                end
            end)
        elseif dungeonName == "Orbital Outpost" then
            game.Workspace.DescendantAdded:Connect(function(descendant)
                if descendant.Name == "Tesla Master" then
                    ResetPlayer()
                end
            end)
        elseif dungeonName == "Volcanic Chambers" then
            dungeon.room8.DescendantAdded:Connect(function(descendant)
                if descendant.Name == "Aggressive Lava Walker" then
                    ResetPlayer()
                end
            end)
        elseif dungeonName == "Enchanted Forest" then
            game.Workspace.DescendantAdded:Connect(function(descendant)
                if descendant.Name == "Crystal Golem" then
                    ResetPlayer()
                end
            end)
        elseif dungeonName == "Gilded Skies" then
            game.Workspace.DescendantAdded:Connect(function(descendant)
                if descendant == "General Cragg" then
                    ResetPlayer()
                end
            end)
    end
end

print("Loaded")
